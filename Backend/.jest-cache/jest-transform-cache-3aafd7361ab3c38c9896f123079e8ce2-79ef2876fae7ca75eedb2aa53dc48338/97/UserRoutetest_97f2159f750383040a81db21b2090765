075af31ba6310708d391a78131a57db5
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const mongoose_1 = __importDefault(require("mongoose"));
const db_1 = require("../../database/db");
const server_1 = __importDefault(require("../../server"));
//import { req } from "../jest.setup";
const UserModel_1 = require("../../src/model/UserModel");
const UserService_1 = require("../../src/services/UserService");
const supertest_1 = __importDefault(require("supertest"));
const a = {
    street: "Street",
    houseNumber: "1",
    postalCode: "12345",
    city: "Berlin",
    country: "Germany",
};
const u = {
    email: "John@doe.com",
    name: {
        first: "John",
        last: "Doe",
    },
    password: "12abcAB!",
    isAdministrator: true,
    address: a,
    birthDate: new Date(),
    gender: "male",
    isActive: true,
    //profilePicture: "picture1",
    socialMediaUrls: {
        facebook: "facebook",
        instagram: "instagram",
    },
};
const JaneData = {
    email: "Jane@doe.com",
    name: {
        first: "Jane",
        last: "Doe",
    },
    password: "12abcAB!",
    isAdministrator: false,
    address: a,
    birthDate: new Date(),
    gender: "male",
    isActive: true,
    // profilePicture: "picture1",
    socialMediaUrls: {
        facebook: "facebook",
        instagram: "instagram",
    },
};
const userService = new UserService_1.UserService();
const NON_EXISTING_ID = "635d2e796ea2e8c9bde5787c";
let admin;
let AdminToken;
let jane;
let token;
let req = (0, supertest_1.default)(server_1.default);
describe("userRoute test", () => {
    beforeAll(async () => await (0, db_1.connect)());
    beforeEach(async () => {
        admin = await userService.createUser(u);
        jane = await userService.createUser(JaneData);
        //const req = request(app);
        const adminloginData = { email: "John@doe.com", password: "12abcAB!" };
        const adminRes = await req.post(`/api/login`).send(adminloginData);
        const AdminLoginResource = adminRes.body;
        AdminToken = AdminLoginResource.access_token;
        const janeLoginData = { email: "Jane@doe.com", password: "12abcAB!" };
        const janeRes = await req.post(`/api/login`).send(janeLoginData);
        const janeLoginResource = janeRes.body;
        token = janeLoginResource.access_token;
    });
    afterEach(async () => await (0, db_1.clearDatabase)());
    afterAll(async () => {
        await mongoose_1.default.connection.close(); // Perform final cleanup after all tests
    });
    test("getUsers", async () => {
        //const req = request(app);
        const response = await req
            .get("/api/users")
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(response.statusCode).toBe(200);
        const users = response.body;
        expect(users.users.length).toBe(3);
        let userPos;
        if (users.users[0].name.first === u.name.first) {
            userPos = 0;
        }
        else if (users.users[1].name.first === u.name.first) {
            userPos = 1;
        }
        else if (users.users[2].name.first === u.name.first) {
            userPos = 2;
        }
        expect(users.users[userPos].id).toBeDefined();
        expect(users.users[userPos].name.first).toBe(u.name.first);
        expect(users.users[userPos].name.last).toBe(u.name.last);
        expect(users.users[userPos].email).toBe(u.email);
        expect(users.users[userPos].password).toBeUndefined();
        expect(users.users[userPos].address).toMatchObject(a);
        //expect(users.users[0].birthDate).toBe(u.birthDate);
        expect(users.users[userPos].gender).toBe(u.gender);
        expect(users.users[userPos].isActive).toBeTruthy();
        //expect(users.users[0].profilePicture).toBe(u.profilePicture);
        expect(users.users[userPos].socialMediaUrls).toMatchObject(u.socialMediaUrls);
    });
    test("getUsers fails on request by non-admin", async () => {
        //const req = request(app);
        const response = await req
            .get("/api/users")
            .set("Authorization", `Bearer ${token}`);
        expect(response.statusCode).toBe(403);
    });
    test("get User request responses with 404 on invalid userID", async () => {
        //const req = request(app);
        const response = await req
            .get(`/api/users/${NON_EXISTING_ID}`)
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(response.statusCode).toBe(404);
    });
    test("get User request responses with 400 on undefined userID", async () => {
        //const req = request(app);
        const response = await req
            .get(`/api/users/invalidID`)
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(response.statusCode).toBe(400);
        expect(response.body.errors).toBeDefined();
    });
    test("get User returns any user when performed by an admin and returns user when performed by non-admin", async () => {
        const response = await req
            .get(`/api/users/${jane.id}`)
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(response.statusCode).toBe(200);
        expect(response.body.name.first).toBe(jane.name.first);
        const res = await req
            .get(`/api/users/${jane.id}`)
            .set("Authorization", `Bearer ${token}`);
        expect(res.statusCode).toBe(200);
        expect(res.body.name.first).toBe(jane.name.first);
    });
    test("put user successfully updates user in db and returns updated user information", async () => {
        const newName = "newName";
        jane.name.last = newName;
        const res = await req
            .put(`/api/users/${jane.id}`)
            .send(jane)
            .set("Authorization", `Bearer ${token}`);
        expect(res.statusCode).toBe(200);
        expect(res.body.name.last).toBe(newName);
        const janeDataFromDB = await UserModel_1.User.findById(jane.id).exec();
        expect(janeDataFromDB.name.last).toBe(newName);
        const updatedName = "newName-adminUpdate";
        jane.name.last = updatedName;
        const response = await req
            .put(`/api/users/${jane.id}`)
            .send(jane)
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(response.body.name.last).toBe(updatedName);
        const janeDataFromDBAdminUpdate = await UserModel_1.User.findById(jane.id).exec();
        expect(janeDataFromDBAdminUpdate.name.last).toBe(updatedName);
    });
    test("should return error on updating email to duplicate email", async () => {
        jane.email = admin.email;
        const res = await req
            .put(`/api/users/${jane.id}`)
            .send(jane)
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(res.statusCode).toBe(404);
    });
    test("should return error on trying to update other users as non-admin", async () => {
        admin.name.first = "newName";
        const res = await req
            .put(`/api/users/${admin.id}`)
            .send(admin)
            .set("Authorization", `Bearer ${token}`);
        expect(res.statusCode).toBe(403);
    });
    test("testing for validation errors on put user route", async () => {
        const invalidUserResource = {
            email: "",
            name: {
                first: "",
                last: "",
            },
            isAdministrator: false,
            address: a,
            birthDate: jane.birthDate,
            gender: "",
            isActive: true,
        };
        const res = await req
            .put(`/api/users/${jane.id}`)
            .send(invalidUserResource)
            .set("Authorization", `Bearer ${token}`);
        expect(res.statusCode).toBe(400);
        expect(res.body.errors).toBeDefined();
    });
    test("put user with invalid old password returns error", async () => {
        const requestData = jane;
        requestData.oldPassword = "invalidPW123!";
        requestData.password = "newStrongPassword123!";
        const res = await req
            .put(`/api/users/${jane.id}`)
            .send(requestData)
            .set("Authorization", `Bearer ${token}`);
        expect(res.statusCode).toBe(403);
        const dbJane = await UserModel_1.User.findById(jane.id).exec();
        expect(await dbJane.isCorrectPassword("newPassowrd")).toBeFalsy();
    });
    test("should allow an admin to delete any user", async () => {
        const response = await req
            .delete(`/api/users/${jane.id}`)
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(response.statusCode).toBe(204);
    });
    test("should allow a user to inactivate their own account", async () => {
        const response = await req
            .delete(`/api/users/${jane.id}`)
            .set("Authorization", `Bearer ${token}`);
        expect(response.statusCode).toBe(204);
    });
    test("should prevent a non-admin user from deleting another user", async () => {
        const response = await req
            .delete(`/api/users/${admin.id}`)
            .set("Authorization", `Bearer ${token}`);
        expect(response.statusCode).toBe(403);
    });
    test("should return an error for an invalid user ID", async () => {
        const response = await req
            .delete(`/api/users/${NON_EXISTING_ID}`)
            .set("Authorization", `Bearer ${AdminToken}`);
        expect(response.statusCode).toBe(404);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxuYWNldVxcT25lRHJpdmVcXERlc2t0b3BcXFN0dWRpdW1cXDUgU2VtZXN0ZXJcXFByb2pla3RcXGNvbm5lY3RhbmRleHBsb3JlXFxCYWNrZW5kXFx0ZXN0c1xccm91dGVzXFxVc2VyUm91dGUudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUFBLHdEQUFnQztBQUNoQywwQ0FBMEU7QUFDMUUsMERBQStCO0FBQy9CLHNDQUFzQztBQUN0Qyx5REFBMkQ7QUFNM0QsZ0VBQTZEO0FBQzdELDBEQUFnQztBQUNoQyxNQUFNLENBQUMsR0FBYTtJQUNsQixNQUFNLEVBQUUsUUFBUTtJQUNoQixXQUFXLEVBQUUsR0FBRztJQUNoQixVQUFVLEVBQUUsT0FBTztJQUNuQixJQUFJLEVBQUUsUUFBUTtJQUNkLE9BQU8sRUFBRSxTQUFTO0NBQ25CLENBQUM7QUFDRixNQUFNLENBQUMsR0FBaUI7SUFDdEIsS0FBSyxFQUFFLGNBQWM7SUFDckIsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFFLE1BQU07UUFDYixJQUFJLEVBQUUsS0FBSztLQUNaO0lBQ0QsUUFBUSxFQUFFLFVBQVU7SUFDcEIsZUFBZSxFQUFFLElBQUk7SUFDckIsT0FBTyxFQUFFLENBQUM7SUFDVixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7SUFDckIsTUFBTSxFQUFFLE1BQU07SUFDZCxRQUFRLEVBQUUsSUFBSTtJQUNkLDZCQUE2QjtJQUM3QixlQUFlLEVBQUU7UUFDZixRQUFRLEVBQUUsVUFBVTtRQUNwQixTQUFTLEVBQUUsV0FBVztLQUN2QjtDQUNGLENBQUM7QUFFRixNQUFNLFFBQVEsR0FBaUI7SUFDN0IsS0FBSyxFQUFFLGNBQWM7SUFDckIsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFFLE1BQU07UUFDYixJQUFJLEVBQUUsS0FBSztLQUNaO0lBQ0QsUUFBUSxFQUFFLFVBQVU7SUFDcEIsZUFBZSxFQUFFLEtBQUs7SUFDdEIsT0FBTyxFQUFFLENBQUM7SUFDVixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7SUFD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QUMsK0NBQStDLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDL0QsTUFBTSxRQUFRLEdBQUcsTUFBTSxHQUFHO2FBQ3ZCLE1BQU0sQ0FBQyxjQUFjLGVBQWUsRUFBRSxDQUFDO2FBQ3ZDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsVUFBVSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hDLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiQzpcXFVzZXJzXFxuYWNldVxcT25lRHJpdmVcXERlc2t0b3BcXFN0dWRpdW1cXDUgU2VtZXN0ZXJcXFByb2pla3RcXGNvbm5lY3RhbmRleHBsb3JlXFxCYWNrZW5kXFx0ZXN0c1xccm91dGVzXFxVc2VyUm91dGUudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbW9uZ29vc2UgZnJvbSBcIm1vbmdvb3NlXCI7XHJcbmltcG9ydCB7IGNsZWFyRGF0YWJhc2UsIGNsb3NlRGF0YWJhc2UsIGNvbm5lY3QgfSBmcm9tIFwiLi4vLi4vZGF0YWJhc2UvZGJcIjtcclxuaW1wb3J0IGFwcCBmcm9tIFwiLi4vLi4vc2VydmVyXCI7XHJcbi8vaW1wb3J0IHsgcmVxIH0gZnJvbSBcIi4uL2plc3Quc2V0dXBcIjtcclxuaW1wb3J0IHsgSUFkZHJlc3MsIFVzZXIgfSBmcm9tIFwiLi4vLi4vc3JjL21vZGVsL1VzZXJNb2RlbFwiO1xyXG5pbXBvcnQge1xyXG4gIExvZ2luUmVzb3VyY2UsXHJcbiAgdXNlclJlc291cmNlLFxyXG4gIHVzZXJzUmVzb3VyY2UsXHJcbn0gZnJvbSBcIi4uLy4uL3NyYy9SZXNvdXJjZXNcIjtcclxuaW1wb3J0IHsgVXNlclNlcnZpY2UgfSBmcm9tIFwiLi4vLi4vc3JjL3NlcnZpY2VzL1VzZXJTZXJ2aWNlXCI7XHJcbmltcG9ydCByZXF1ZXN0IGZyb20gXCJzdXBlcnRlc3RcIjtcclxuY29uc3QgYTogSUFkZHJlc3MgPSB7XHJcbiAgc3RyZWV0OiBcIlN0cmVldFwiLFxyXG4gIGhvdXNlTnVtYmVyOiBcIjFcIixcclxuICBwb3N0YWxDb2RlOiBcIjEyMzQ1XCIsXHJcbiAgY2l0eTogXCJCZXJsaW5cIixcclxuICBjb3VudHJ5OiBcIkdlcm1hbnlcIixcclxufTtcclxuY29uc3QgdTogdXNlclJlc291cmNlID0ge1xyXG4gIGVtYWlsOiBcIkpvaG5AZG9lLmNvbVwiLFxyXG4gIG5hbWU6IHtcclxuICAgIGZpcnN0OiBcIkpvaG5cIixcclxuICAgIGxhc3Q6IFwiRG9lXCIsXHJcbiAgfSxcclxuICBwYXNzd29yZDogXCIxMmFiY0FCIVwiLFxyXG4gIGlzQWRtaW5pc3RyYXRvcjogdHJ1ZSxcclxuICBhZGRyZXNzOiBhLFxyXG4gIGJpcnRoRGF0ZTogbmV3IERhdGUoKSxcclxuICBnZW5kZXI6IFwibWFsZVwiLFxyXG4gIGlzQWN0aXZlOiB0cnVlLFxyXG4gIC8vcHJvZmlsZVBpY3R1cmU6IFwicGljdHVyZTFcIixcclxuICBzb2NpYWxNZWRpYVVybHM6IHtcclxuICAgIGZhY2Vib29rOiBcImZhY2Vib29rXCIsXHJcbiAgICBpbnN0YWdyYW06IFwiaW5zdGFncmFtXCIsXHJcbiAgfSxcclxufTtcclxuXHJcbmNvbnN0IEphbmVEYXRhOiB1c2VyUmVzb3VyY2UgPSB7XHJcbiAgZW1haWw6IFwiSmFuZUBkb2UuY29tXCIsXHJcbiAgbmFtZToge1xyXG4gICAgZmlyc3Q6IFwiSmFuZVwiLFxyXG4gICAgbGFzdDogXCJEb2VcIixcclxuICB9LFxyXG4gIHBhc3N3b3JkOiBcIjEyYWJjQUIhXCIsXHJcbiAgaXNBZG1pbmlzdHJhdG9yOiBmYWxzZSxcclxuICBhZGRyZXNzOiBhLFxyXG4gIGJpcnRoRGF0ZTogbmV3IERhdGUoKSxcclxuICBnZW5kZXI6IFwibWFsZVwiLFxyXG4gIGlzQWN0aXZlOiB0cnVlLFxyXG4gIC8vIHByb2ZpbGVQaWN0dXJlOiBcInBpY3R1cmUxXCIsXHJcbiAgc29jaWFsTWVkaWFVcmxzOiB7XHJcbiAgICBmYWNlYm9vazogXCJmYWNlYm9va1wiLFxyXG4gICAgaW5zdGFncmFtOiBcImluc3RhZ3JhbVwiLFxyXG4gIH0sXHJcbn07XHJcblxyXG5jb25zdCB1c2VyU2VydmljZTogVXNlclNlcnZpY2UgPSBuZXcgVXNlclNlcnZpY2UoKTtcclxuY29uc3QgTk9OX0VYSVNUSU5HX0lEID0gXCI2MzVkMmU3OTZlYTJlOGM5YmRlNTc4N2NcIjtcclxubGV0IGFkbWluOiB1c2VyUmVzb3VyY2U7XHJcbmxldCBBZG1pblRva2VuOiBzdHJpbmc7XHJcbmxldCBqYW5lOiB1c2VyUmVzb3VyY2U7XHJcbmxldCB0b2tlbjogc3RyaW5nO1xyXG5sZXQgcmVxID0gcmVxdWVzdChhcHApO1xyXG5kZXNjcmliZShcInVzZXJSb3V0ZSB0ZXN0XCIsICgpID0+IHtcclxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4gYXdhaXQgY29ubmVjdCgpKTtcclxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcclxuICAgIGFkbWluID0gYXdhaXQgdXNlclNlcnZpY2UuY3JlYXRlVXNlcih1KTtcclxuICAgIGphbmUgPSBhd2FpdCB1c2VyU2VydmljZS5jcmVhdGVVc2VyKEphbmVEYXRhKTtcclxuICAgIC8vY29uc3QgcmVxID0gcmVxdWVzdChhcHApO1xyXG4gICAgY29uc3QgYWRtaW5sb2dpbkRhdGEgPSB7IGVtYWlsOiBcIkpvaG5AZG9lLmNvbVwiLCBwYXNzd29yZDogXCIxMmFiY0FCIVwiIH07XHJcbiAgICBjb25zdCBhZG1pblJlcyA9IGF3YWl0IHJlcS5wb3N0KGAvYXBpL2xvZ2luYCkuc2VuZChhZG1pbmxvZ2luRGF0YSk7XHJcbiAgICBjb25zdCBBZG1pbkxvZ2luUmVzb3VyY2UgPSBhZG1pblJlcy5ib2R5IGFzIExvZ2luUmVzb3VyY2U7XHJcbiAgICBBZG1pblRva2VuID0gQWRtaW5Mb2dpblJlc291cmNlLmFjY2Vzc190b2tlbjtcclxuXHJcbiAgICBjb25zdCBqYW5lTG9naW5EYXRhID0geyBlbWFpbDogXCJKYW5lQGRvZS5jb21cIiwgcGFzc3dvcmQ6IFwiMTJhYmNBQiFcIiB9O1xyXG4gICAgY29uc3QgamFuZVJlcyA9IGF3YWl0IHJlcS5wb3N0KGAvYXBpL2xvZ2luYCkuc2VuZChqYW5lTG9naW5EYXRhKTtcclxuICAgIGNvbnN0IGphbmVMb2dpblJlc291cmNlID0gamFuZVJlcy5ib2R5IGFzIExvZ2luUmVzb3VyY2U7XHJcbiAgICB0b2tlbiA9IGphbmVMb2dpblJlc291cmNlLmFjY2Vzc190b2tlbjtcclxuICB9KTtcclxuICBhZnRlckVhY2goYXN5bmMgKCkgPT4gYXdhaXQgY2xlYXJEYXRhYmFzZSgpKTtcclxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XHJcbiAgICBhd2FpdCBtb25nb29zZS5jb25uZWN0aW9uLmNsb3NlKCk7IC8vIFBlcmZvcm0gZmluYWwgY2xlYW51cCBhZnRlciBhbGwgdGVzdHNcclxuICB9KTtcclxuXHJcbiAgdGVzdChcImdldFVzZXJzXCIsIGFzeW5jICgpID0+IHtcclxuICAgIC8vY29uc3QgcmVxID0gcmVxdWVzdChhcHApO1xyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXFcclxuICAgICAgLmdldChcIi9hcGkvdXNlcnNcIilcclxuICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke0FkbWluVG9rZW59YCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG9CZSgyMDApO1xyXG4gICAgY29uc3QgdXNlcnM6IHVzZXJzUmVzb3VyY2UgPSByZXNwb25zZS5ib2R5O1xyXG4gICAgZXhwZWN0KHVzZXJzLnVzZXJzLmxlbmd0aCkudG9CZSgzKTtcclxuICAgIGxldCB1c2VyUG9zOiBudW1iZXI7XHJcbiAgICBpZiAodXNlcnMudXNlcnNbMF0ubmFtZS5maXJzdCA9PT0gdS5uYW1lLmZpcnN0KSB7XHJcbiAgICAgIHVzZXJQb3MgPSAwO1xyXG4gICAgfSBlbHNlIGlmICh1c2Vycy51c2Vyc1sxXS5uYW1lLmZpcnN0ID09PSB1Lm5hbWUuZmlyc3QpIHtcclxuICAgICAgdXNlclBvcyA9IDE7XHJcbiAgICB9IGVsc2UgaWYgKHVzZXJzLnVzZXJzWzJdLm5hbWUuZmlyc3QgPT09IHUubmFtZS5maXJzdCkge1xyXG4gICAgICB1c2VyUG9zID0gMjtcclxuICAgIH1cclxuICAgIGV4cGVjdCh1c2Vycy51c2Vyc1t1c2VyUG9zXS5pZCkudG9CZURlZmluZWQoKTtcclxuICAgIGV4cGVjdCh1c2Vycy51c2Vyc1t1c2VyUG9zXS5uYW1lLmZpcnN0KS50b0JlKHUubmFtZS5maXJzdCk7XHJcbiAgICBleHBlY3QodXNlcnMudXNlcnNbdXNlclBvc10ubmFtZS5sYXN0KS50b0JlKHUubmFtZS5sYXN0KTtcclxuICAgIGV4cGVjdCh1c2Vycy51c2Vyc1t1c2VyUG9zXS5lbWFpbCkudG9CZSh1LmVtYWlsKTtcclxuICAgIGV4cGVjdCh1c2Vycy51c2Vyc1t1c2VyUG9zXS5wYXNzd29yZCkudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgZXhwZWN0KHVzZXJzLnVzZXJzW3VzZXJQb3NdLmFkZHJlc3MpLnRvTWF0Y2hPYmplY3QoYSk7XHJcbiAgICAvL2V4cGVjdCh1c2Vycy51c2Vyc1swXS5iaXJ0aERhdGUpLnRvQmUodS5iaXJ0aERhdGUpO1xyXG4gICAgZXhwZWN0KHVzZXJzLnVzZXJzW3VzZXJQb3NdLmdlbmRlcikudG9CZSh1LmdlbmRlcik7XHJcbiAgICBleHBlY3QodXNlcnMudXNlcnNbdXNlclBvc10uaXNBY3RpdmUpLnRvQmVUcnV0aHkoKTtcclxuICAgIC8vZXhwZWN0KHVzZXJzLnVzZXJzWzBdLnByb2ZpbGVQaWN0dXJlKS50b0JlKHUucHJvZmlsZVBpY3R1cmUpO1xyXG4gICAgZXhwZWN0KHVzZXJzLnVzZXJzW3VzZXJQb3NdLnNvY2lhbE1lZGlhVXJscykudG9NYXRjaE9iamVjdChcclxuICAgICAgdS5zb2NpYWxNZWRpYVVybHNcclxuICAgICk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoXCJnZXRVc2VycyBmYWlscyBvbiByZXF1ZXN0IGJ5IG5vbi1hZG1pblwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvL2NvbnN0IHJlcSA9IHJlcXVlc3QoYXBwKTtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxXHJcbiAgICAgIC5nZXQoXCIvYXBpL3VzZXJzXCIpXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHt0b2tlbn1gKTtcclxuICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50b0JlKDQwMyk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoXCJnZXQgVXNlciByZXF1ZXN0IHJlc3BvbnNlcyB3aXRoIDQwNCBvbiBpbnZhbGlkIHVzZXJJRFwiLCBhc3luYyAoKSA9PiB7XHJcbiAgICAvL2NvbnN0IHJlcSA9IHJlcXVlc3QoYXBwKTtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxXHJcbiAgICAgIC5nZXQoYC9hcGkvdXNlcnMvJHtOT05fRVhJU1RJTkdfSUR9YClcclxuICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke0FkbWluVG9rZW59YCk7XHJcblxyXG4gICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvQmUoNDA0KTtcclxuICB9KTtcclxuXHJcbiAgdGVzdChcImdldCBVc2VyIHJlcXVlc3QgcmVzcG9uc2VzIHdpdGggNDAwIG9uIHVuZGVmaW5lZCB1c2VySURcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgLy9jb25zdCByZXEgPSByZXF1ZXN0KGFwcCk7XHJcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcVxyXG4gICAgICAuZ2V0KGAvYXBpL3VzZXJzL2ludmFsaWRJRGApXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHtBZG1pblRva2VufWApO1xyXG5cclxuICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2UuYm9keS5lcnJvcnMpLnRvQmVEZWZpbmVkKCk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoXCJnZXQgVXNlciByZXR1cm5zIGFueSB1c2VyIHdoZW4gcGVyZm9ybWVkIGJ5IGFuIGFkbWluIGFuZCByZXR1cm5zIHVzZXIgd2hlbiBwZXJmb3JtZWQgYnkgbm9uLWFkbWluXCIsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxXHJcbiAgICAgIC5nZXQoYC9hcGkvdXNlcnMvJHtqYW5lLmlkfWApXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHtBZG1pblRva2VufWApO1xyXG4gICAgZXhwZWN0KHJlc3BvbnNlLnN0YXR1c0NvZGUpLnRvQmUoMjAwKTtcclxuICAgIGV4cGVjdChyZXNwb25zZS5ib2R5Lm5hbWUuZmlyc3QpLnRvQmUoamFuZS5uYW1lLmZpcnN0KTtcclxuXHJcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXFcclxuICAgICAgLmdldChgL2FwaS91c2Vycy8ke2phbmUuaWR9YClcclxuICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke3Rva2VufWApO1xyXG4gICAgZXhwZWN0KHJlcy5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XHJcbiAgICBleHBlY3QocmVzLmJvZHkubmFtZS5maXJzdCkudG9CZShqYW5lLm5hbWUuZmlyc3QpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KFwicHV0IHVzZXIgc3VjY2Vzc2Z1bGx5IHVwZGF0ZXMgdXNlciBpbiBkYiBhbmQgcmV0dXJucyB1cGRhdGVkIHVzZXIgaW5mb3JtYXRpb25cIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgbmV3TmFtZSA9IFwibmV3TmFtZVwiO1xyXG4gICAgamFuZS5uYW1lLmxhc3QgPSBuZXdOYW1lO1xyXG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVxXHJcbiAgICAgIC5wdXQoYC9hcGkvdXNlcnMvJHtqYW5lLmlkfWApXHJcbiAgICAgIC5zZW5kKGphbmUpXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHt0b2tlbn1gKTtcclxuICAgIGV4cGVjdChyZXMuc3RhdHVzQ29kZSkudG9CZSgyMDApO1xyXG4gICAgZXhwZWN0KHJlcy5ib2R5Lm5hbWUubGFzdCkudG9CZShuZXdOYW1lKTtcclxuXHJcbiAgICBjb25zdCBqYW5lRGF0YUZyb21EQiA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoamFuZS5pZCkuZXhlYygpO1xyXG4gICAgZXhwZWN0KGphbmVEYXRhRnJvbURCLm5hbWUubGFzdCkudG9CZShuZXdOYW1lKTtcclxuXHJcbiAgICBjb25zdCB1cGRhdGVkTmFtZSA9IFwibmV3TmFtZS1hZG1pblVwZGF0ZVwiO1xyXG4gICAgamFuZS5uYW1lLmxhc3QgPSB1cGRhdGVkTmFtZTtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxXHJcbiAgICAgIC5wdXQoYC9hcGkvdXNlcnMvJHtqYW5lLmlkfWApXHJcbiAgICAgIC5zZW5kKGphbmUpXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHtBZG1pblRva2VufWApO1xyXG4gICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkubmFtZS5sYXN0KS50b0JlKHVwZGF0ZWROYW1lKTtcclxuXHJcbiAgICBjb25zdCBqYW5lRGF0YUZyb21EQkFkbWluVXBkYXRlID0gYXdhaXQgVXNlci5maW5kQnlJZChqYW5lLmlkKS5leGVjKCk7XHJcbiAgICBleHBlY3QoamFuZURhdGFGcm9tREJBZG1pblVwZGF0ZS5uYW1lLmxhc3QpLnRvQmUodXBkYXRlZE5hbWUpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KFwic2hvdWxkIHJldHVybiBlcnJvciBvbiB1cGRhdGluZyBlbWFpbCB0byBkdXBsaWNhdGUgZW1haWxcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgamFuZS5lbWFpbCA9IGFkbWluLmVtYWlsO1xyXG4gICAgY29uc3QgcmVzID0gYXdhaXQgcmVxXHJcbiAgICAgIC5wdXQoYC9hcGkvdXNlcnMvJHtqYW5lLmlkfWApXHJcbiAgICAgIC5zZW5kKGphbmUpXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHtBZG1pblRva2VufWApO1xyXG4gICAgZXhwZWN0KHJlcy5zdGF0dXNDb2RlKS50b0JlKDQwNCk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoXCJzaG91bGQgcmV0dXJuIGVycm9yIG9uIHRyeWluZyB0byB1cGRhdGUgb3RoZXIgdXNlcnMgYXMgbm9uLWFkbWluXCIsIGFzeW5jICgpID0+IHtcclxuICAgIGFkbWluLm5hbWUuZmlyc3QgPSBcIm5ld05hbWVcIjtcclxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcVxyXG4gICAgICAucHV0KGAvYXBpL3VzZXJzLyR7YWRtaW4uaWR9YClcclxuICAgICAgLnNlbmQoYWRtaW4pXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHt0b2tlbn1gKTtcclxuICAgIGV4cGVjdChyZXMuc3RhdHVzQ29kZSkudG9CZSg0MDMpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KFwidGVzdGluZyBmb3IgdmFsaWRhdGlvbiBlcnJvcnMgb24gcHV0IHVzZXIgcm91dGVcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgaW52YWxpZFVzZXJSZXNvdXJjZTogdXNlclJlc291cmNlID0ge1xyXG4gICAgICBlbWFpbDogXCJcIixcclxuICAgICAgbmFtZToge1xyXG4gICAgICAgIGZpcnN0OiBcIlwiLFxyXG4gICAgICAgIGxhc3Q6IFwiXCIsXHJcbiAgICAgIH0sXHJcbiAgICAgIGlzQWRtaW5pc3RyYXRvcjogZmFsc2UsXHJcbiAgICAgIGFkZHJlc3M6IGEsXHJcbiAgICAgIGJpcnRoRGF0ZTogamFuZS5iaXJ0aERhdGUsXHJcbiAgICAgIGdlbmRlcjogXCJcIixcclxuICAgICAgaXNBY3RpdmU6IHRydWUsXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHJlcVxyXG4gICAgICAucHV0KGAvYXBpL3VzZXJzLyR7amFuZS5pZH1gKVxyXG4gICAgICAuc2VuZChpbnZhbGlkVXNlclJlc291cmNlKVxyXG4gICAgICAuc2V0KFwiQXV0aG9yaXphdGlvblwiLCBgQmVhcmVyICR7dG9rZW59YCk7XHJcbiAgICBleHBlY3QocmVzLnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcclxuICAgIGV4cGVjdChyZXMuYm9keS5lcnJvcnMpLnRvQmVEZWZpbmVkKCk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoXCJwdXQgdXNlciB3aXRoIGludmFsaWQgb2xkIHBhc3N3b3JkIHJldHVybnMgZXJyb3JcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgcmVxdWVzdERhdGEgPSBqYW5lO1xyXG4gICAgcmVxdWVzdERhdGEub2xkUGFzc3dvcmQgPSBcImludmFsaWRQVzEyMyFcIjtcclxuICAgIHJlcXVlc3REYXRhLnBhc3N3b3JkID0gXCJuZXdTdHJvbmdQYXNzd29yZDEyMyFcIjtcclxuXHJcbiAgICBjb25zdCByZXMgPSBhd2FpdCByZXFcclxuICAgICAgLnB1dChgL2FwaS91c2Vycy8ke2phbmUuaWR9YClcclxuICAgICAgLnNlbmQocmVxdWVzdERhdGEpXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHt0b2tlbn1gKTtcclxuICAgIGV4cGVjdChyZXMuc3RhdHVzQ29kZSkudG9CZSg0MDMpO1xyXG5cclxuICAgIGNvbnN0IGRiSmFuZSA9IGF3YWl0IFVzZXIuZmluZEJ5SWQoamFuZS5pZCkuZXhlYygpO1xyXG4gICAgZXhwZWN0KGF3YWl0IGRiSmFuZS5pc0NvcnJlY3RQYXNzd29yZChcIm5ld1Bhc3Nvd3JkXCIpKS50b0JlRmFsc3koKTtcclxuICB9KTtcclxuXHJcbiAgdGVzdChcInNob3VsZCBhbGxvdyBhbiBhZG1pbiB0byBkZWxldGUgYW55IHVzZXJcIiwgYXN5bmMgKCkgPT4ge1xyXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXFcclxuICAgICAgLmRlbGV0ZShgL2FwaS91c2Vycy8ke2phbmUuaWR9YClcclxuICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke0FkbWluVG9rZW59YCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG9CZSgyMDQpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KFwic2hvdWxkIGFsbG93IGEgdXNlciB0byBpbmFjdGl2YXRlIHRoZWlyIG93biBhY2NvdW50XCIsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxXHJcbiAgICAgIC5kZWxldGUoYC9hcGkvdXNlcnMvJHtqYW5lLmlkfWApXHJcbiAgICAgIC5zZXQoXCJBdXRob3JpemF0aW9uXCIsIGBCZWFyZXIgJHt0b2tlbn1gKTtcclxuICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXNDb2RlKS50b0JlKDIwNCk7XHJcbiAgfSk7XHJcblxyXG4gIHRlc3QoXCJzaG91bGQgcHJldmVudCBhIG5vbi1hZG1pbiB1c2VyIGZyb20gZGVsZXRpbmcgYW5vdGhlciB1c2VyXCIsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxXHJcbiAgICAgIC5kZWxldGUoYC9hcGkvdXNlcnMvJHthZG1pbi5pZH1gKVxyXG4gICAgICAuc2V0KFwiQXV0aG9yaXphdGlvblwiLCBgQmVhcmVyICR7dG9rZW59YCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG9CZSg0MDMpO1xyXG4gIH0pO1xyXG5cclxuICB0ZXN0KFwic2hvdWxkIHJldHVybiBhbiBlcnJvciBmb3IgYW4gaW52YWxpZCB1c2VyIElEXCIsIGFzeW5jICgpID0+IHtcclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxXHJcbiAgICAgIC5kZWxldGUoYC9hcGkvdXNlcnMvJHtOT05fRVhJU1RJTkdfSUR9YClcclxuICAgICAgLnNldChcIkF1dGhvcml6YXRpb25cIiwgYEJlYXJlciAke0FkbWluVG9rZW59YCk7XHJcbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzQ29kZSkudG9CZSg0MDQpO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sInZlcnNpb24iOjN9